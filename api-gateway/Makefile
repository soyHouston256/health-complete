# Makefile para API Gateway

# Variables
BINARY_NAME=api-gateway
DOCKER_IMAGE=api-gateway:latest
DOCKER_COMPOSE=docker-compose
GO_VERSION=1.21

# Colores para output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

.PHONY: help build run clean test deps docker-build docker-run docker-stop dev

# Comando por defecto
help: ## Mostrar ayuda
	@echo "$(BLUE)API Gateway - Comandos disponibles:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-15s$(NC) %s\n", $$1, $$2}'

# Desarrollo
deps: ## Instalar dependencias
	@echo "$(YELLOW)ğŸ“¦ Instalando dependencias...$(NC)"
	go mod download
	go mod tidy

build: ## Construir binario
	@echo "$(YELLOW)ğŸ”¨ Construyendo aplicaciÃ³n...$(NC)"
	CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o $(BINARY_NAME) .
	@echo "$(GREEN)âœ… Build completado: $(BINARY_NAME)$(NC)"

run: build ## Ejecutar aplicaciÃ³n
	@echo "$(YELLOW)ğŸš€ Iniciando API Gateway...$(NC)"
	./$(BINARY_NAME)

dev: ## Ejecutar en modo desarrollo con hot reload
	@echo "$(YELLOW)ğŸ”¥ Iniciando en modo desarrollo...$(NC)"
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "$(RED)âŒ Air no estÃ¡ instalado. Instalando...$(NC)"; \
		go install github.com/cosmtrek/air@latest; \
		air; \
	fi

clean: ## Limpiar archivos generados
	@echo "$(YELLOW)ğŸ§¹ Limpiando archivos...$(NC)"
	go clean
	rm -f $(BINARY_NAME)
	docker system prune -f
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

# Testing
test: ## Ejecutar tests
	@echo "$(YELLOW)ğŸ§ª Ejecutando tests...$(NC)"
	go test -v ./...

test-coverage: ## Ejecutar tests con coverage
	@echo "$(YELLOW)ğŸ“Š Ejecutando tests con coverage...$(NC)"
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "$(GREEN)âœ… Coverage report: coverage.html$(NC)"

test-race: ## Ejecutar tests con race detector
	@echo "$(YELLOW)ğŸƒ Ejecutando tests con race detector...$(NC)"
	go test -race -v ./...

benchmark: ## Ejecutar benchmarks
	@echo "$(YELLOW)âš¡ Ejecutando benchmarks...$(NC)"
	go test -bench=. -benchmem ./...

# Docker
docker-build: ## Construir imagen Docker
	@echo "$(YELLOW)ğŸ³ Construyendo imagen Docker...$(NC)"
	docker build -t $(DOCKER_IMAGE) .
	@echo "$(GREEN)âœ… Imagen Docker construida: $(DOCKER_IMAGE)$(NC)"

docker-run: ## Ejecutar con Docker Compose
	@echo "$(YELLOW)ğŸš€ Iniciando servicios con Docker Compose...$(NC)"
	$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)âœ… Servicios iniciados$(NC)"
	@echo "$(BLUE)ğŸ“ API Gateway: http://localhost:8080$(NC)"
	@echo "$(BLUE)ğŸ“ Redis Commander: http://localhost:8081$(NC)"

docker-stop: ## Detener servicios Docker
	@echo "$(YELLOW)ğŸ›‘ Deteniendo servicios...$(NC)"
	$(DOCKER_COMPOSE) down
	@echo "$(GREEN)âœ… Servicios detenidos$(NC)"

docker-logs: ## Ver logs de Docker Compose
	@echo "$(YELLOW)ğŸ“‹ Mostrando logs...$(NC)"
	$(DOCKER_COMPOSE) logs -f

docker-restart: ## Reiniciar servicios Docker
	@echo "$(YELLOW)ğŸ”„ Reiniciando servicios...$(NC)"
	$(DOCKER_COMPOSE) restart

# Servicios de ejemplo
example-services: ## Ejecutar servicios de ejemplo
	@echo "$(YELLOW)ğŸ¯ Iniciando servicios de ejemplo...$(NC)"
	@cd examples/services/user-service && go run main.go &
	@cd examples/services/order-service && go run main.go &
	@cd examples/services/payment-service && go run main.go &
	@echo "$(GREEN)âœ… Servicios de ejemplo iniciados$(NC)"

stop-examples: ## Detener servicios de ejemplo
	@echo "$(YELLOW)ğŸ›‘ Deteniendo servicios de ejemplo...$(NC)"
	@pkill -f "go run main.go" || true
	@echo "$(GREEN)âœ… Servicios de ejemplo detenidos$(NC)"

# Herramientas
install-tools: ## Instalar herramientas de desarrollo
	@echo "$(YELLOW)ğŸ”§ Instalando herramientas...$(NC)"
	go install github.com/cosmtrek/air@latest
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install github.com/rakyll/hey@latest
	@echo "$(GREEN)âœ… Herramientas instaladas$(NC)"

lint: ## Ejecutar linter
	@echo "$(YELLOW)ğŸ” Ejecutando linter...$(NC)"
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run; \
	else \
		echo "$(RED)âŒ golangci-lint no estÃ¡ instalado. Ejecuta: make install-tools$(NC)"; \
	fi

format: ## Formatear cÃ³digo
	@echo "$(YELLOW)ğŸ’… Formateando cÃ³digo...$(NC)"
	go fmt ./...
	@echo "$(GREEN)âœ… CÃ³digo formateado$(NC)"

# Pruebas de carga
load-test: ## Ejecutar prueba de carga bÃ¡sica
	@echo "$(YELLOW)âš¡ Ejecutando prueba de carga...$(NC)"
	@if command -v hey > /dev/null; then \
		hey -n 1000 -c 10 http://localhost:8001/health; \
	else \
		echo "$(RED)âŒ hey no estÃ¡ instalado. Ejecuta: make install-tools$(NC)"; \
	fi

load-test-auth: ## Prueba de carga con autenticaciÃ³n
	@echo "$(YELLOW)ğŸ” Ejecutando prueba de carga con auth...$(NC)"
	@if command -v hey > /dev/null; then \
		hey -n 1000 -c 10 -H "Authorization: Bearer test-token" http://localhost:8001/api/lead/; \
	else \
		echo "$(RED)âŒ hey no estÃ¡ instalado. Ejecuta: make install-tools$(NC)"; \
	fi

# Monitoreo
health: ## Verificar salud del gateway
	@echo "$(YELLOW)ğŸ¥ Verificando salud del gateway...$(NC)"
	@curl -s http://localhost:8001/health | jq . || echo "$(RED)âŒ Gateway no responde$(NC)"

health-services: ## Verificar salud de servicios
	@echo "$(YELLOW)ğŸ¥ Verificando salud de servicios...$(NC)"
	@curl -s http://localhost:8001/health/services | jq . || echo "$(RED)âŒ No se pudo obtener estado de servicios$(NC)"

logs: ## Ver logs en tiempo real (requiere Docker)
	@echo "$(YELLOW)ğŸ“‹ Mostrando logs del gateway...$(NC)"
	$(DOCKER_COMPOSE) logs -f api-gateway

# ConfiguraciÃ³n
config-validate: ## Validar configuraciÃ³n
	@echo "$(YELLOW)âœ… Validando configuraciÃ³n...$(NC)"
	@if [ -f config/config.json ]; then \
		cat config/config.json | jq . > /dev/null && echo "$(GREEN)âœ… ConfiguraciÃ³n vÃ¡lida$(NC)"; \
	else \
		echo "$(RED)âŒ Archivo config/config.json no encontrado$(NC)"; \
	fi

config-example: ## Crear configuraciÃ³n de ejemplo
	@echo "$(YELLOW)ğŸ“ Creando configuraciÃ³n de ejemplo...$(NC)"
	@cp config/config.json config/config.example.json
	@echo "$(GREEN)âœ… ConfiguraciÃ³n de ejemplo creada: config/config.example.json$(NC)"

# Base de datos
redis-cli: ## Conectar a Redis CLI
	@echo "$(YELLOW)ğŸ”— Conectando a Redis...$(NC)"
	docker exec -it $$(docker-compose ps -q redis) redis-cli

redis-flush: ## Limpiar cache de Redis
	@echo "$(YELLOW)ğŸ§¹ Limpiando cache de Redis...$(NC)"
	docker exec -it $$(docker-compose ps -q redis) redis-cli FLUSHALL
	@echo "$(GREEN)âœ… Cache limpiado$(NC)"

# DocumentaciÃ³n
docs: ## Generar documentaciÃ³n
	@echo "$(YELLOW)ğŸ“š Generando documentaciÃ³n...$(NC)"
	@if command -v godoc > /dev/null; then \
		echo "$(BLUE)ğŸ“ DocumentaciÃ³n disponible en: http://localhost:6060/pkg/api-gateway/$(NC)"; \
		godoc -http=:6060; \
	else \
		echo "$(RED)âŒ godoc no estÃ¡ instalado$(NC)"; \
	fi

# Release
version: ## Mostrar informaciÃ³n de versiÃ³n
	@echo "$(BLUE)ğŸ“‹ InformaciÃ³n de versiÃ³n:$(NC)"
	@echo "Go version: $$(go version)"
	@echo "Git commit: $$(git rev-parse --short HEAD 2>/dev/null || echo 'N/A')"
	@echo "Build date: $$(date)"

# Todo en uno
all: clean deps build test ## Ejecutar pipeline completo

setup: deps install-tools ## ConfiguraciÃ³n inicial completa
	@echo "$(GREEN)ğŸ‰ ConfiguraciÃ³n inicial completada$(NC)"
	@echo "$(BLUE)ğŸ“ Ejecuta 'make dev' para iniciar en modo desarrollo$(NC)"
	@echo "$(BLUE)ğŸ“ Usa 'make test-services' para probar tus servicios$(NC)"

quick-start: docker-build docker-run ## Inicio rÃ¡pido con Docker
	@echo "$(GREEN)ğŸ‰ API Gateway iniciado con Docker$(NC)"
	@echo "$(BLUE)ğŸ“ Gateway: http://localhost:8001$(NC)"
	@echo "$(BLUE)ğŸ“ Health: http://localhost:8001/health$(NC)"

# Comandos especÃ­ficos para tus servicios
test-services: ## Probar tus servicios con formato estÃ¡ndar
	@echo "$(YELLOW)ğŸ§ª Probando servicios con formato estÃ¡ndar...$(NC)"
	@chmod +x examples/test_standard_format.sh
	@./examples/test_standard_format.sh

test-no-duplication: ## Verificar que NO hay duplicaciÃ³n en respuestas
	@echo "$(YELLOW)ğŸ” Verificando NO duplicaciÃ³n...$(NC)"
	@chmod +x examples/test_no_duplication.sh
	@./examples/test_no_duplication.sh

test-format: ## Verificar formato de respuesta estÃ¡ndar
	@echo "$(BLUE)ğŸ” Verificando formato de respuesta estÃ¡ndar...$(NC)"
	@echo "Health check:"
	@curl -s http://localhost:8001/health | jq '. | {success, data: .data.status, errorMessage}'
	@echo "Services health:"
	@curl -s http://localhost:8001/health/services | jq '. | {success, errorMessage}'

test-metrics: ## Ver mÃ©tricas del gateway
	@echo "$(BLUE)ğŸ“ˆ Obteniendo mÃ©tricas del gateway...$(NC)"
	@curl -s http://localhost:8001/metrics | jq .

generate-token: ## Generar token JWT para testing
	@echo "$(YELLOW)ğŸ” Generando token JWT...$(NC)"
	@echo "Uso: make generate-token USER_ID=user123 USERNAME=john ROLE=user"
	@if [ -z "$(USER_ID)" ] || [ -z "$(USERNAME)" ] || [ -z "$(ROLE)" ]; then \
		echo "$(RED)âŒ Faltan parÃ¡metros. Ejemplo:$(NC)"; \
		echo "make generate-token USER_ID=user123 USERNAME=john ROLE=user"; \
	else \
		cd examples && go run generate_token.go $(USER_ID) $(USERNAME) $(ROLE); \
	fi

test-lead: ## Test rÃ¡pido del servicio Lead
	@echo "$(BLUE)ğŸ¯ Testing Lead service...$(NC)"
	@echo "Health check:"
	@curl -s -X GET http://localhost:8001/api/lead/health -w "Status: %{http_code}, Time: %{time_total}s\n" | head -5
	@echo "RaÃ­z:"
	@curl -s -X GET http://localhost:8001/api/lead/ -w "Status: %{http_code}, Time: %{time_total}s\n" | head -5

test-captcha: ## Test rÃ¡pido del servicio reCAPTCHA
	@echo "$(BLUE)ğŸ”’ Testing reCAPTCHA service...$(NC)"
	@curl -s -X GET http://localhost:8001/ms-validate-recaptcha/api/health -w "Status: %{http_code}, Time: %{time_total}s\n" | head -5

enable-auth: ## Habilitar autenticaciÃ³n en el gateway
	@echo "$(YELLOW)ğŸ” Habilitando autenticaciÃ³n...$(NC)"
	@sed -i '' 's/"enabled": false/"enabled": true/' config/config.json
	@echo "$(GREEN)âœ… AutenticaciÃ³n habilitada. Reinicia el gateway.$(NC)"

disable-auth: ## Deshabilitar autenticaciÃ³n en el gateway
	@echo "$(YELLOW)ğŸ”“ Deshabilitando autenticaciÃ³n...$(NC)"
	@sed -i '' 's/"enabled": true/"enabled": false/' config/config.json
	@echo "$(GREEN)âœ… AutenticaciÃ³n deshabilitada. Reinicia el gateway.$(NC)"